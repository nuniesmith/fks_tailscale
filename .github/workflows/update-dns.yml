name: Update Cloudflare DNS

on:
    push:
        branches: [main, master]
    workflow_dispatch:
        inputs:
            force_update:
                description: "Force update even if IP matches"
                required: false
                default: false
                type: boolean
    schedule:
        # Run daily at 2 AM UTC to check and update if needed
        - cron: "0 2 * * *"

env:
    CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
    CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    DNS_RECORD_NAME: fkstrading.xyz
    TAILSCALE_HOSTNAME: fkstrading-xyz

jobs:
    update-dns:
        runs-on: ubuntu-latest
        if: github.event_name != 'pull_request'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up kubectl
              uses: azure/setup-kubectl@v3
              with:
                  version: "latest"

            - name: Configure kubectl for minikube
              run: |
                  mkdir -p ~/.kube
                  echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config || echo "KUBECONFIG secret not set, using default"
                  chmod 600 ~/.kube/config

            - name: Get Tailscale IP
              id: get-ip
              continue-on-error: false
              run: |
                  TAILSCALE_IP=""
                  
                  # Method 1: Try to get from Tailscale API (if accessible)
                  if [ -n "${{ secrets.TAILSCALE_API_KEY }}" ]; then
                    echo "Attempting to get IP from Tailscale API..."
                    API_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.TAILSCALE_API_KEY }}" \
                      "https://api.tailscale.com/api/v2/device/${TAILSCALE_HOSTNAME}" 2>/dev/null || echo "")
                    
                    if [ -n "$API_RESPONSE" ] && echo "$API_RESPONSE" | jq -e '.addresses' >/dev/null 2>&1; then
                      TAILSCALE_IP=$(echo "$API_RESPONSE" | jq -r '.addresses[]? | select(startswith("100."))' | head -1)
                      if [ -n "$TAILSCALE_IP" ]; then
                        echo "âœ… Got IP from Tailscale API: $TAILSCALE_IP"
                      fi
                    fi
                  fi

                  # Method 2: Get from Kubernetes pod status (check pod IPs)
                  if [ -z "$TAILSCALE_IP" ]; then
                    echo "Attempting to get IP from Kubernetes pod..."
                    # Try to get from pod's status or annotations
                    TAILSCALE_IP=$(kubectl get pod -n fks-trading -l app=tailscale-connector -o jsonpath='{.items[0].status.podIP}' 2>/dev/null | grep -E '^100\.' | head -1 || echo "")
                    if [ -z "$TAILSCALE_IP" ]; then
                      # Try to exec into pod and get IP
                      TAILSCALE_IP=$(kubectl exec -n fks-trading -l app=tailscale-connector -- tailscale status --json 2>/dev/null | jq -r '.Self.addresses[]? | select(startswith("100."))' | head -1 || echo "")
                    fi
                    if [ -n "$TAILSCALE_IP" ]; then
                      echo "âœ… Got IP from Kubernetes: $TAILSCALE_IP"
                    fi
                  fi

                  # Method 3: Get from Kubernetes service (LoadBalancer)
                  if [ -z "$TAILSCALE_IP" ]; then
                    echo "Attempting to get IP from Kubernetes service..."
                    TAILSCALE_IP=$(kubectl get svc tailscale-connector -n fks-trading -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
                    if [ -z "$TAILSCALE_IP" ]; then
                      TAILSCALE_IP=$(kubectl get svc tailscale-connector -n fks-trading -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null | grep -E '^100\.' | head -1 || echo "")
                    fi
                    if [ -n "$TAILSCALE_IP" ]; then
                      echo "âœ… Got IP from Kubernetes service: $TAILSCALE_IP"
                    fi
                  fi

                  # Method 4: Resolve Tailscale hostname via DNS
                  if [ -z "$TAILSCALE_IP" ]; then
                    echo "Attempting to resolve Tailscale hostname..."
                    if command -v dig >/dev/null 2>&1; then
                      TAILSCALE_IP=$(dig +short ${TAILSCALE_HOSTNAME}.tailscale.ts.net 2>/dev/null | grep -E '^100\.' | head -1 || echo "")
                    fi
                    if [ -n "$TAILSCALE_IP" ]; then
                      echo "âœ… Got IP from DNS resolution: $TAILSCALE_IP"
                    fi
                  fi

                  # Method 5: Try to get from Tailscale status file (if accessible via kubectl)
                  if [ -z "$TAILSCALE_IP" ]; then
                    echo "Attempting to get IP from Tailscale status..."
                    STATUS_JSON=$(kubectl exec -n fks-trading -l app=tailscale-connector -- tailscale status --json 2>/dev/null || echo "")
                    if [ -n "$STATUS_JSON" ]; then
                      TAILSCALE_IP=$(echo "$STATUS_JSON" | jq -r '.Self.addresses[]? | select(startswith("100."))' | head -1 || echo "")
                      if [ -n "$TAILSCALE_IP" ]; then
                        echo "âœ… Got IP from Tailscale status: $TAILSCALE_IP"
                      fi
                    fi
                  fi

                  # Final check - if still no IP, make it optional or use manual input
                  if [ -z "$TAILSCALE_IP" ]; then
                    echo "âš ï¸  Could not automatically determine Tailscale IP"
                    echo ""
                    echo "Available methods tried:"
                    echo "  1. Tailscale API (requires TAILSCALE_API_KEY secret)"
                    echo "  2. Kubernetes pod status"
                    echo "  3. Kubernetes service LoadBalancer"
                    echo "  4. DNS resolution (${TAILSCALE_HOSTNAME}.tailscale.ts.net)"
                    echo "  5. Tailscale status command"
                    echo ""
                    echo "ðŸ’¡ Solutions:"
                    echo "  - Add TAILSCALE_API_KEY to GitHub secrets"
                    echo "  - Ensure Tailscale connector pod is running"
                    echo "  - Manually set TAILSCALE_IP secret with current IP"
                    echo "  - Check Tailscale admin console: https://login.tailscale.com/admin/machines"
                    echo ""
                    # Allow workflow to continue if TAILSCALE_IP secret is set manually
                    if [ -n "${{ secrets.TAILSCALE_IP }}" ]; then
                      TAILSCALE_IP="${{ secrets.TAILSCALE_IP }}"
                      echo "âœ… Using manually configured TAILSCALE_IP secret: $TAILSCALE_IP"
                    else
                      echo "âŒ No Tailscale IP found and TAILSCALE_IP secret not set"
                      echo "Setting workflow to continue but skip DNS update..."
                      echo "tailscale_ip=" >> $GITHUB_OUTPUT
                      echo "skip_update=true" >> $GITHUB_OUTPUT
                      exit 0
                    fi
                  fi

                  echo "âœ… Final Tailscale IP: $TAILSCALE_IP"
                  echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT
                  echo "skip_update=false" >> $GITHUB_OUTPUT

            - name: Get current Cloudflare DNS record
              id: get-dns
              if: steps.get-ip.outputs.skip_update != 'true'
              run: |
                  CURRENT_IP=$(curl -s -X GET \
                    "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records?type=A&name=${DNS_RECORD_NAME}" \
                    -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    | jq -r '.result[0].content // empty')

                  if [ -z "$CURRENT_IP" ]; then
                    echo "âš ï¸  DNS record not found, will create new record"
                    echo "current_ip=" >> $GITHUB_OUTPUT
                    echo "record_id=" >> $GITHUB_OUTPUT
                  else
                    RECORD_ID=$(curl -s -X GET \
                      "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records?type=A&name=${DNS_RECORD_NAME}" \
                      -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                      -H "Content-Type: application/json" \
                      | jq -r '.result[0].id // empty')
                    
                    echo "âœ… Current DNS IP: $CURRENT_IP"
                    echo "current_ip=$CURRENT_IP" >> $GITHUB_OUTPUT
                    echo "record_id=$RECORD_ID" >> $GITHUB_OUTPUT
                  fi

            - name: Compare IPs and update if needed
              id: update-dns
              run: |
                  TAILSCALE_IP="${{ steps.get-ip.outputs.tailscale_ip }}"
                  CURRENT_IP="${{ steps.get-dns.outputs.current_ip }}"
                  RECORD_ID="${{ steps.get-dns.outputs.record_id }}"
                  FORCE_UPDATE="${{ github.event.inputs.force_update }}"

                  if [ "$TAILSCALE_IP" = "$CURRENT_IP" ] && [ "$FORCE_UPDATE" != "true" ]; then
                    echo "âœ… IPs match ($TAILSCALE_IP), no update needed"
                    echo "updated=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  echo "ðŸ”„ IPs differ or force update requested"
                  echo "  Current DNS: $CURRENT_IP"
                  echo "  Tailscale IP: $TAILSCALE_IP"

                  if [ -z "$RECORD_ID" ]; then
                    # Create new DNS record
                    echo "Creating new DNS record..."
                    RESPONSE=$(curl -s -X POST \
                      "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records" \
                      -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                      -H "Content-Type: application/json" \
                      --data "{\"type\":\"A\",\"name\":\"${DNS_RECORD_NAME}\",\"content\":\"${TAILSCALE_IP}\",\"ttl\":300}")
                    
                    SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
                    if [ "$SUCCESS" = "true" ]; then
                      echo "âœ… DNS record created successfully"
                      echo "updated=true" >> $GITHUB_OUTPUT
                    else
                      echo "âŒ Failed to create DNS record"
                      echo "$RESPONSE" | jq '.'
                      exit 1
                    fi
                  else
                    # Update existing DNS record
                    echo "Updating existing DNS record..."
                    RESPONSE=$(curl -s -X PUT \
                      "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records/${RECORD_ID}" \
                      -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                      -H "Content-Type: application/json" \
                      --data "{\"type\":\"A\",\"name\":\"${DNS_RECORD_NAME}\",\"content\":\"${TAILSCALE_IP}\",\"ttl\":300}")
                    
                    SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
                    if [ "$SUCCESS" = "true" ]; then
                      echo "âœ… DNS record updated successfully"
                      echo "updated=true" >> $GITHUB_OUTPUT
                    else
                      echo "âŒ Failed to update DNS record"
                      echo "$RESPONSE" | jq '.'
                      exit 1
                    fi
                  fi

            - name: Summary
              if: always()
              run: |
                  echo "## DNS Update Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ steps.get-ip.outputs.skip_update }}" = "true" ]; then
                    echo "âš ï¸ **Update Skipped** - Could not determine Tailscale IP" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "See workflow logs for troubleshooting steps." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
                    echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Tailscale IP | \`${{ steps.get-ip.outputs.tailscale_ip }}\` |" >> $GITHUB_STEP_SUMMARY
                    echo "| Previous DNS IP | \`${{ steps.get-dns.outputs.current_ip }}\` |" >> $GITHUB_STEP_SUMMARY
                    echo "| Updated | ${{ steps.update-dns.outputs.updated }} |" >> $GITHUB_STEP_SUMMARY
                    echo "| DNS Record | \`${DNS_RECORD_NAME}\` |" >> $GITHUB_STEP_SUMMARY
                  fi
